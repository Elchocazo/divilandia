<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DiviLandia: Aventura de Mundos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CORRECCI√ìN: Eliminamos position: fixed y ajustamos min-height para permitir el scroll */
        body {
            font-family: 'Fredoka', sans-serif;
            transition: background-color 0.5s ease;
            overscroll-behavior: none;
            user-select: none;
            min-height: 100vh; /* Asegura que el body pueda crecer */
            display: flex; /* Usamos flex para centrar y manejar el contenido verticalmente */
            flex-direction: column;
            align-items: center;
            padding-top: 24px;
            padding-bottom: 80px; /* Espacio extra para el footer */
            overflow-x: hidden; /* Previene scroll horizontal */
        }

        .handwritten { font-family: 'Patrick Hand', cursive; }

        .app-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1), 0 20px 20px rgba(0,0,0,0.05);
            overflow: hidden;
            border-width: 6px;
            border-style: solid;
            transition: border-color 0.5s ease;
        }

        .input-overlay {
            position: absolute;
            width: 60px;
            height: 60px;
            font-family: 'Patrick Hand', cursive;
            font-size: 38px;
            text-align: center;
            background: #fffbeb;
            border: 3px dashed #d97706;
            border-radius: 12px;
            outline: none;
            z-index: 10;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            letter-spacing: 2px;
            color: #333;
        }
        .input-overlay:focus {
            background: #fff;
            transform: translate(-50%, -50%) scale(1.15);
        }

        .mission-card {
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .mission-card:hover:not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15);
        }
        .mission-card.locked {
            opacity: 0.6;
            filter: grayscale(1);
            cursor: not-allowed;
            background-color: #e5e7eb;
        }
        
        .btn-action {
            transition: all 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        .btn-action:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }

        .pet-slot {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: white;
            border-radius: 1rem;
            box-shadow: inset 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .pet-slot:hover { transform: scale(1.05); }
        .pet-slot.empty { background: #f1f5f9; color: #cbd5e1; font-size: 1.5rem; }
        
        .hidden { display: none !important; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes hatch { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .hatching { animation: hatch 0.5s infinite; }

        /* Estilos Minijuego Tablas */
        .table-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px dashed #ddd;
            font-size: 1.2rem;
            color: #444;
        }
        .table-row.new {
            background-color: #dcfce7;
            animation: highlight 0.5s;
        }
        @keyframes highlight { from { background-color: #86efac; } to { background-color: #dcfce7; } }
    </style>
</head>
<body id="bodyTheme" class="bg-green-50">
    <!-- C√≥digo propiedad de 'el chocazo' -->

    <!-- MEN√ö PRINCIPAL -->
    <div id="mainMenu" class="w-full max-w-5xl px-3">
        <div class="text-center mb-8">
            <div class="inline-block bg-white px-8 py-4 rounded-3xl shadow-lg border-b-8 border-gray-200 mb-4">
                <h1 class="text-5xl md:text-6xl font-bold text-gray-700 drop-shadow-sm animate-float">üåç DiviLandia Saga</h1>
            </div>
            <p class="text-xl text-gray-600 font-handwritten mt-2">Viaja por mundos, resuelve divisiones y colecciona criaturas.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 items-start">
            <div class="flex-1 w-full">
                <div id="worldContainer" class="space-y-8"></div>
            </div>
            <div class="w-full lg:w-80 shrink-0 lg:sticky lg:top-4">
                <div class="bg-white rounded-3xl p-6 shadow-xl border-4 border-gray-100 relative overflow-hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">üéí Tu Colecci√≥n</h2>
                    <div id="eggContainer" class="bg-gray-50 rounded-xl p-3 mb-4 flex justify-center items-center min-h-[80px] border-2 border-gray-200 shadow-inner cursor-pointer hover:bg-white transition-colors" onclick="app.hatchEgg()">
                        <span class="text-gray-400 text-sm text-center italic">Juega para ganar<br>huevos misteriosos.</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2 max-h-[400px] overflow-y-auto pr-1" id="petGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA DE JUEGO -->
    <div id="gameView" class="app-container px-3 hidden">
        <!-- HUD -->
        <div class="flex justify-between items-center mb-4">
            <button onclick="app.goToMenu()" class="bg-white hover:bg-gray-50 text-gray-700 font-bold py-2 px-5 rounded-xl btn-action border-2 border-gray-200 flex items-center gap-2">
                <span>‚¨Ö</span> Mapa
            </button>
            <div class="flex flex-col items-center">
                <div id="themeBadge" class="bg-white px-6 py-2 rounded-2xl border-b-4 border-gray-200 shadow-sm flex items-center gap-3 text-gray-700">
                    <span class="text-2xl" id="worldIconDisplay">üå≤</span>
                    <div class="text-center">
                        <div class="text-xs font-bold uppercase tracking-wider opacity-70">Nivel</div>
                        <div class="text-xl font-bold leading-none" id="levelTitleDisplay">1</div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                 <!-- Bot√≥n de Ayuda para abrir Minijuego -->
                <button onclick="app.openTableHelper()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-xl btn-action border-2 border-blue-300 flex items-center gap-2" title="Construir Tabla">
                    <span>üÜò</span> <span class="hidden sm:inline">Ayuda</span>
                </button>
                <div class="bg-white px-4 py-2 rounded-xl border-b-4 border-gray-200 shadow-sm">
                    <div class="text-xs font-bold text-gray-400 uppercase text-center">Progreso</div>
                    <div class="text-xl font-bold text-gray-600">
                        <span id="progressCurrent">1</span> / <span id="progressTotal">10</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="messageBox" class="w-full bg-white border-l-8 border-gray-500 text-gray-800 p-5 rounded-2xl shadow-md mb-6 min-h-[80px] flex items-center text-xl font-medium relative overflow-hidden transition-colors duration-300">
            <div class="relative z-10" id="messageText">¬°Prep√°rate!</div>
        </div>

        <div class="canvas-wrapper" id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
            <input type="text" inputmode="none" id="virtualInput" class="input-overlay hidden" readonly>
        </div>

        <div class="mt-6 flex justify-center">
            <button id="mainActionBtn" onclick="window.game.handleAction()" class="bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 px-12 rounded-2xl btn-action w-full max-w-xs hidden shadow-orange-700">
                Continuar ‚û°
            </button>
        </div>

        <div id="numpad" class="mt-6 w-full max-w-lg mx-auto hidden">
            <div id="numpadContainer" class="bg-gray-800 p-3 rounded-3xl shadow-xl border-b-8 border-gray-900 transition-colors duration-300">
                <div class="grid grid-cols-3 gap-2">
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(1)">1</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(2)">2</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(3)">3</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(4)">4</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(5)">5</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(6)">6</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(7)">7</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(8)">8</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(9)">9</button>
                    <button class="btn-action bg-red-100 text-red-600 text-2xl font-bold p-4 rounded-xl" onclick="window.game.deleteDigit()">‚å´</button>
                    <button class="btn-action bg-gray-50 text-gray-800 text-2xl font-bold p-4 rounded-xl" onclick="window.game.inputDigit(0)">0</button>
                    <button id="enterBtn" class="btn-action bg-green-500 text-white text-2xl font-bold p-4 rounded-xl border-b-4 border-green-700" onclick="window.game.submitInput()">‚úî</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="levelCompleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-[90%] text-center shadow-2xl animate-float border-4 border-yellow-400 relative">
            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-8xl">üéÅ</div>
            <h2 class="text-3xl font-bold text-yellow-600 mt-10 mb-2 font-handwritten">¬°Nivel Completado!</h2>
            <p class="text-gray-600 text-lg mb-6">¬°Has ganado un regalo de este mundo!</p>
            <button onclick="app.finishLevel()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold py-4 px-8 rounded-2xl btn-action shadow-yellow-700">
                Abrir Regalo üêæ
            </button>
        </div>
    </div>

    <div id="problemCompleteModal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-40 hidden backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl p-6 max-w-xs w-[90%] text-center shadow-xl border-b-8 border-blue-500 transform scale-100 transition-transform">
            <div class="text-5xl mb-2 animate-bounce">‚ú®</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">¬°Correcto!</h2>
            <button onclick="app.nextProblem()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl btn-action w-full">
                Siguiente ‚û°
            </button>
        </div>
    </div>

    <!-- Minijuego Overlay: Constructor de Tablas -->
    <div id="tableHelperModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 max-w-md w-[95%] shadow-2xl border-4 border-blue-400 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b-2 border-blue-100 pb-2">
                <h3 class="text-2xl font-bold text-blue-700">Constructor de Tabla</h3>
                <button onclick="app.closeTableHelper()" class="text-gray-400 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-xl mb-4 text-center">
                <p class="text-blue-800 font-medium">Si no te sabes la tabla del <span id="helperDivisorNum" class="font-bold text-2xl">4</span>, ¬°constr√∫yela sumando!</p>
            </div>

            <!-- √Årea de filas generadas -->
            <div id="tableRowsContainer" class="flex-1 overflow-y-auto bg-gray-50 rounded-xl p-4 border-2 border-gray-200 mb-4 space-y-2">
                <!-- JS inyectar√° filas aqu√≠ -->
            </div>

            <!-- Bot√≥n de Sumar -->
            <button onclick="app.addTableStep()" class="w-full bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-4 px-8 rounded-2xl btn-action shadow-green-700 flex items-center justify-center gap-3">
                <span>‚ûï</span> Sumar <span id="helperAddNum">4</span>
            </button>
        </div>
    </div>

    <!-- Pie de p√°gina con los cr√©ditos solicitados -->
    <footer class="mt-6 text-sm text-gray-500 text-center w-full max-w-5xl px-3">
        Hecho por el profe manuel
    </footer>

<script>
/**
 * CONFIGURACI√ìN DE DATOS
 */
const APP_DATA = {
    progress: 1, 
    petsUnlocked: [], 
    hasPendingEgg: false,
    lastPlayedMapId: 'bosque',
    maps: [
        { id: 'bosque', name: 'Bosque Encantado', icon: 'üå≤', themeColor: 'green', bgGradient: 'from-green-50 to-emerald-100', levelsStart: 1, levelsEnd: 5, pets: ['üê∂','üê±','ü¶ä','üêª','ü¶â','üê∫','üêó','üê∞','üêøÔ∏è','ü¶î','ü¶å','ü¶ó','ü¶ã','üêû','üê∏','üê≠','ü¶á','üå≤','üçÑ','ü™µ'] },
        { id: 'oceano', name: 'Oc√©ano Profundo', icon: 'üåä', themeColor: 'cyan', bgGradient: 'from-cyan-50 to-blue-100', levelsStart: 6, levelsEnd: 10, pets: ['üêü','üê†','üê°','ü¶à','üêô','ü¶ë','ü¶Ä','ü¶û','ü¶ê','üê¨','üêã','üê≥','üê¢','üêö','üê°','üêä','üêß','ü¶Ü','üåä','‚öì'] },
        { id: 'sabana', name: 'Sabana Salvaje', icon: 'ü¶Å', themeColor: 'orange', bgGradient: 'from-orange-50 to-yellow-100', levelsStart: 11, levelsEnd: 15, pets: ['ü¶Å','üêØ','ü¶í','ü¶ì','üêò','ü¶õ','ü¶è','üêÜ','üêÉ','üêÇ','üêí','ü¶ç','ü¶ß','üêÖ','üê™','üê´','üêç','ü¶Ö','üåµ','‚òÄÔ∏è'] }
    ],
    levels: [
        { id: 1, mapId: 'bosque', count: 5, digits: 2, divisorRange: [2, 4], exact: true },
        { id: 2, mapId: 'bosque', count: 5, digits: 2, divisorRange: [3, 5], exact: true },
        { id: 3, mapId: 'bosque', count: 8, digits: 3, divisorRange: [2, 5], exact: true },
        { id: 4, mapId: 'bosque', count: 8, digits: 3, divisorRange: [3, 6], exact: true },
        { id: 5, mapId: 'bosque', count: 10, digits: 3, divisorRange: [2, 5], exact: false },
        { id: 6, mapId: 'oceano', count: 5, digits: 3, divisorRange: [4, 7], exact: true },
        { id: 7, mapId: 'oceano', count: 8, digits: 3, divisorRange: [5, 8], exact: true },
        { id: 8, mapId: 'oceano', count: 10, digits: 3, divisorRange: [4, 8], exact: false },
        { id: 9, mapId: 'oceano', count: 12, digits: 4, divisorRange: [2, 5], exact: true },
        { id: 10, mapId: 'oceano', count: 12, digits: 4, divisorRange: [3, 6], exact: false },
        { id: 11, mapId: 'sabana', count: 8, digits: 3, divisorRange: [6, 9], exact: false },
        { id: 12, mapId: 'sabana', count: 10, digits: 4, divisorRange: [4, 8], exact: true },
        { id: 13, mapId: 'sabana', count: 12, digits: 4, divisorRange: [5, 9], exact: false },
        { id: 14, mapId: 'sabana', count: 15, digits: 4, divisorRange: [6, 9], exact: false },
        { id: 15, mapId: 'sabana', count: 15, digits: 5, divisorRange: [2, 9], exact: false }
    ]
};

/**
 * GESTOR DE LA APLICACI√ìN
 */
class AppManager {
    constructor() {
        this.currentLevelIdx = 0;
        this.problemsSolvedInLevel = 0;
        this.renderMenu();
        this.renderPets();
        
        // Estado Minijuego
        this.helperState = { divisor: 2, currentStep: 0, currentSum: 0 };
    }

    getMapById(mapId) { return APP_DATA.maps.find(m => m.id === mapId); }

    renderMenu() {
        const container = document.getElementById('worldContainer');
        container.innerHTML = '';
        APP_DATA.maps.forEach(map => {
            const mapSection = document.createElement('div');
            mapSection.className = `bg-gradient-to-br ${map.bgGradient} rounded-3xl p-6 shadow-md border-2 border-${map.themeColor}-200`;
            mapSection.innerHTML = `
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-4xl shadow-sm bg-white rounded-full p-2">${map.icon}</span>
                    <h2 class="text-2xl font-bold text-${map.themeColor}-800">${map.name}</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 levels-grid"></div>
            `;
            const grid = mapSection.querySelector('.levels-grid');
            const mapLevels = APP_DATA.levels.filter(l => l.mapId === map.id);
            mapLevels.forEach(level => {
                const isLocked = level.id > APP_DATA.progress;
                const btn = document.createElement('button');
                btn.className = `mission-card rounded-xl p-3 flex flex-col items-center justify-center h-24 border-b-4 text-center ${isLocked ? 'locked border-gray-300 bg-gray-100 text-gray-400' : `bg-white border-${map.themeColor}-200 text-${map.themeColor}-700 hover:bg-${map.themeColor}-50`}`;
                let statusIcon = isLocked ? 'üîí' : (level.id < APP_DATA.progress ? '‚≠ê' : '‚ñ∂Ô∏è');
                btn.innerHTML = `<span class="text-2xl mb-1">${statusIcon}</span><span class="font-bold text-sm">Nivel ${level.id}</span>`;
                if (!isLocked) btn.onclick = () => this.startLevel(level.id - 1);
                grid.appendChild(btn);
            });
            container.appendChild(mapSection);
        });
        this.updateEggStatus();
        document.body.className = "bg-gray-50 flex flex-col items-center pt-6 px-3 pb-12 overflow-y-auto"; // Modificado aqu√≠
        document.getElementById('mainMenu').classList.remove('hidden');
        document.getElementById('gameView').classList.add('hidden');
        document.getElementById('levelCompleteModal').classList.add('hidden');
    }

    updateEggStatus() {
        const container = document.getElementById('eggContainer');
        if (APP_DATA.hasPendingEgg) {
            const map = this.getMapById(APP_DATA.lastPlayedMapId);
            container.innerHTML = `<div class="flex flex-col items-center animate-bounce"><span class="text-5xl hatching cursor-pointer drop-shadow-md">üéÅ</span><span class="text-xs font-bold text-${map.themeColor}-600 mt-2">¬°ABRIR REGALO!</span></div>`;
            container.className = `rounded-xl p-3 mb-4 flex justify-center items-center min-h-[80px] border-2 cursor-pointer transition-colors bg-${map.themeColor}-50 border-${map.themeColor}-200`;
        } else {
            container.innerHTML = `<span class="text-gray-400 text-xs text-center italic">Completa niveles para<br>ganar regalos.</span>`;
            container.className = "bg-gray-50 rounded-xl p-3 mb-4 flex justify-center items-center min-h-[80px] border-2 border-gray-200 shadow-inner cursor-pointer";
        }
    }

    renderPets() {
        const grid = document.getElementById('petGrid');
        grid.innerHTML = '';
        const totalSlots = Math.max(12, APP_DATA.petsUnlocked.length + 4);
        for(let i=0; i<totalSlots; i++) {
            const slot = document.createElement('div');
            if (i < APP_DATA.petsUnlocked.length) {
                slot.className = 'pet-slot border-gray-200 bg-white text-4xl';
                slot.textContent = APP_DATA.petsUnlocked[i];
            } else {
                slot.className = 'pet-slot empty';
                slot.textContent = '?';
            }
            grid.appendChild(slot);
        }
    }

    hatchEgg() {
        if (!APP_DATA.hasPendingEgg) return;
        APP_DATA.hasPendingEgg = false;
        const map = this.getMapById(APP_DATA.lastPlayedMapId);
        const mapCollection = map.pets;
        const available = mapCollection.filter(p => !APP_DATA.petsUnlocked.includes(p));
        const newPet = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : mapCollection[Math.floor(Math.random() * mapCollection.length)];
        APP_DATA.petsUnlocked.push(newPet);
        let colors = map.id === 'oceano' ? ['#0ea5e9', '#22d3ee'] : (map.id === 'sabana' ? ['#f97316', '#eab308'] : ['#22c55e', '#84cc16']);
        confetti({ particleCount: 100, spread: 70, origin: { x: 0.8, y: 0.5 }, colors: colors });
        this.renderPets();
        this.updateEggStatus();
    }

    startLevel(levelIdx) {
        this.currentLevelIdx = levelIdx;
        this.problemsSolvedInLevel = 0;
        const levelConfig = APP_DATA.levels[levelIdx];
        APP_DATA.lastPlayedMapId = levelConfig.mapId;
        const currentMap = this.getMapById(levelConfig.mapId);
        this.applyTheme(currentMap);
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('gameView').classList.remove('hidden');
        document.getElementById('levelTitleDisplay').textContent = levelConfig.id;
        document.getElementById('worldIconDisplay').textContent = currentMap.icon;
        document.getElementById('progressTotal').textContent = levelConfig.count;
        this.loadNextProblem();
    }

    applyTheme(map) {
        document.body.className = `bg-${map.themeColor}-50 flex flex-col items-center pt-6 px-3 pb-12 overflow-y-auto`; // Modificado aqu√≠
        document.getElementById('messageBox').className = `w-full bg-white border-l-8 border-${map.themeColor}-500 text-${map.themeColor}-800 p-5 rounded-2xl shadow-md mb-6 min-h-[80px] flex items-center text-xl font-medium relative overflow-hidden`;
        const canvasWrap = document.getElementById('canvasContainer');
        canvasWrap.style.borderColor = this.getHexColor(map.themeColor);
        canvasWrap.style.boxShadow = `0 10px 0 ${this.getHexColorDark(map.themeColor)}`;
        document.getElementById('numpadContainer').className = `bg-${map.themeColor}-800 p-3 rounded-3xl shadow-xl border-b-8 border-${map.themeColor}-900`;
        document.getElementById('enterBtn').className = `btn-action bg-${map.themeColor}-500 text-white text-2xl font-bold p-4 rounded-xl border-b-4 border-${map.themeColor}-700`;
        const input = document.getElementById('virtualInput');
        input.style.borderColor = this.getHexColor(map.themeColor);
        input.style.color = this.getHexColorDark(map.themeColor);
    }

    getHexColor(colorName) {
        if(colorName === 'green') return '#22c55e';
        if(colorName === 'cyan') return '#06b6d4';
        if(colorName === 'orange') return '#f97316';
        return '#22c55e';
    }
    getHexColorDark(colorName) {
        if(colorName === 'green') return '#15803d';
        if(colorName === 'cyan') return '#0e7490';
        if(colorName === 'orange') return '#c2410c';
        return '#15803d';
    }

    loadNextProblem() {
        document.getElementById('progressCurrent').textContent = this.problemsSolvedInLevel + 1;
        document.getElementById('problemCompleteModal').classList.add('hidden');
        const levelConfig = APP_DATA.levels[this.currentLevelIdx];
        const currentMap = this.getMapById(levelConfig.mapId);
        window.game.setConfigColors(this.getHexColor(currentMap.themeColor), this.getHexColorDark(currentMap.themeColor));
        const problem = this.generateProblem(levelConfig);
        window.game.startNewGame(problem.dividend, problem.divisor);
    }

    generateProblem(config) {
        let divisor = Math.floor(Math.random() * (config.divisorRange[1] - config.divisorRange[0] + 1)) + config.divisorRange[0];
        let minQuotient = Math.pow(10, config.digits - 2); 
        let maxQuotient = Math.pow(10, config.digits - 1); 
        let quotient = Math.floor(Math.random() * (maxQuotient - minQuotient)) + minQuotient;
        let dividend = quotient * divisor;
        if (!config.exact) {
            if (Math.random() > 0.4) {
                const remainder = Math.floor(Math.random() * (divisor - 1)) + 1;
                dividend += remainder;
            }
        }
        let attempts = 0;
        while (dividend.toString().length !== config.digits && attempts < 10) {
             divisor = Math.floor(Math.random() * (config.divisorRange[1] - config.divisorRange[0] + 1)) + config.divisorRange[0];
             quotient = Math.floor(Math.random() * (maxQuotient - minQuotient * 2)) + minQuotient;
             dividend = quotient * divisor;
             if (!config.exact && Math.random() > 0.4) dividend += Math.floor(Math.random() * (divisor - 1)) + 1;
             attempts++;
        }
        return { dividend, divisor };
    }

    problemSolved() {
        this.problemsSolvedInLevel++;
        const levelConfig = APP_DATA.levels[this.currentLevelIdx];
        confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 } });
        if (this.problemsSolvedInLevel >= levelConfig.count) {
            this.missionComplete();
        } else {
            // Se pausa un poco para ver el resultado final escrito
            setTimeout(() => {
                document.getElementById('problemCompleteModal').classList.remove('hidden');
            }, 1500);
        }
    }

    missionComplete() {
        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        if (this.currentLevelIdx + 1 === APP_DATA.progress && APP_DATA.progress < APP_DATA.levels.length) APP_DATA.progress++;
        APP_DATA.hasPendingEgg = true;
        setTimeout(() => { document.getElementById('levelCompleteModal').classList.remove('hidden'); }, 1500);
    }

    finishLevel() {
        document.getElementById('levelCompleteModal').classList.add('hidden');
        this.goToMenu();
    }

    nextProblem() { this.loadNextProblem(); }
    goToMenu() { this.renderMenu(); }

    // --- MINIJUEGO CONSTRUCTOR DE TABLAS ---
    openTableHelper() {
        const divisor = window.game.DIVISOR;
        this.helperState = { divisor: divisor, currentStep: 0, currentSum: 0 };
        document.getElementById('helperDivisorNum').textContent = divisor;
        document.getElementById('helperAddNum').textContent = divisor;
        document.getElementById('tableRowsContainer').innerHTML = '';
        document.getElementById('tableHelperModal').classList.remove('hidden');
    }

    closeTableHelper() {
        document.getElementById('tableHelperModal').classList.add('hidden');
    }

    addTableStep() {
        if (this.helperState.currentStep >= 10) return;
        
        this.helperState.currentStep++;
        const prevSum = this.helperState.currentSum;
        const newSum = prevSum + this.helperState.divisor;
        this.helperState.currentSum = newSum;

        const rowDiv = document.createElement('div');
        rowDiv.className = 'table-row new';
        
        // Formato: "4 x 1 = 4" o "4 + 4 = 8 (4 x 2)"
        let text = "";
        if (this.helperState.currentStep === 1) {
            text = `<span>${this.helperState.divisor} &times; 1 = </span> <strong class="text-blue-600">${newSum}</strong>`;
        } else {
            text = `<span>${prevSum} + ${this.helperState.divisor} = </span> <strong class="text-blue-600">${newSum}</strong> <span class="text-sm text-gray-500 ml-2">(${this.helperState.divisor}&times;${this.helperState.currentStep})</span>`;
        }
        
        rowDiv.innerHTML = text;
        const container = document.getElementById('tableRowsContainer');
        container.appendChild(rowDiv);
        container.scrollTop = container.scrollHeight;
    }
}

const app = new AppManager();

/**
 * MOTOR DEL JUEGO
 */
class DivisionEngine {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.container = document.getElementById('canvasContainer');
        this.msgBox = document.getElementById('messageText');
        this.inputEl = document.getElementById('virtualInput');
        this.actionBtn = document.getElementById('mainActionBtn');
        this.numpad = document.getElementById('numpad');

        this.DIVIDEND = 0;
        this.DIVISOR = 0;
        this.steps = [];
        this.state = {
            stepIndex: -1, 
            inputValue: '',
            history: { quotient: [], products: [], residues: [], partials: [] },
            highlightInfo: null,
            waitingForContinue: false,
            isFinished: false 
        };
        this.alignmentMap = [];
        this.logicalWidth = 800;
        this.logicalHeight = 600;
        
        this.config = {
            startX: 200,
            startY: 100,
            spacing: 50,
            lineH: 60,
            fontMain: 'bold 40px "Fredoka"',
            colors: { text: '#374151', accent: '#22c55e', highlight: 'rgba(250, 204, 21, 0.4)', success: '#16a34a', error: '#dc2626', pencil: '#57534e' }
        };
        this.initListeners();
    }

    setConfigColors(primary, dark) {
        this.config.colors.accent = primary;
        this.config.colors.text = dark;
    }

    initListeners() {
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', (e) => {
            if (document.getElementById('gameView').classList.contains('hidden')) return;
            if (this.state.stepIndex === -1) return; 
            if (e.key >= '0' && e.key <= '9') this.inputDigit(parseInt(e.key));
            else if (e.key === 'Backspace') this.deleteDigit();
            else if (e.key === 'Enter') {
                if (!this.actionBtn.classList.contains('hidden')) this.handleAction();
                else this.submitInput();
            }
        });
    }

    startNewGame(dividend, divisor) {
        this.DIVIDEND = dividend;
        this.DIVISOR = divisor;
        this.state = {
            stepIndex: 0,
            inputValue: '',
            history: { quotient: [], products: [], residues: [], partials: [] },
            highlightInfo: null,
            waitingForContinue: false,
            isFinished: false
        };
        this.alignmentMap = [];
        this.steps = this.solveDivision(dividend, divisor);
        this.actionBtn.classList.add('hidden');
        this.numpad.classList.remove('hidden');
        this.resize();
        this.updateUI();
        this.showInputForCurrentStep();
    }

    solveDivision(dividend, divisor) {
        const digits = dividend.toString().split('').map(Number);
        const steps = [];
        let currentVal = 0;
        let currentIndex = 0;
        let tempVal = digits[0];
        let digitsTaken = 1;
        if (tempVal < divisor && digits.length > 1) { tempVal = tempVal * 10 + digits[1]; digitsTaken = 2; }
        currentVal = tempVal;
        currentIndex = digitsTaken - 1;
        this.state.highlightInfo = { start: 0, length: digitsTaken, row: 0, isPartial: false };
        this.alignmentMap.push(currentIndex);
        while (true) {
            const q = Math.floor(currentVal / divisor);
            steps.push({ type: 'COC', correct: q, msg: `¬øCu√°ntas veces cabe ${divisor} en ${currentVal}?` });
            const currentRow = this.alignmentMap.length - 1;
            const prod = q * divisor;
            steps.push({ type: 'PROD', correct: prod, msg: `Multiplica ${q} √ó ${divisor} y escr√≠belo.`, row: currentRow });
            const rem = currentVal - prod;
            const hasMore = currentIndex < digits.length - 1;
            let nextPartVal = null;
            let bringIdx = null;
            if (hasMore) {
                currentIndex++; 
                this.alignmentMap.push(currentIndex);
                const nextDigit = digits[currentIndex];
                bringIdx = currentIndex;
                nextPartVal = rem * 10 + nextDigit;
                currentVal = nextPartVal;
            }
            steps.push({ type: 'RESTO', correct: rem, msg: hasMore ? `Resta ${prod} para ver cu√°nto sobra.` : `¬°Terminado!`, row: currentRow, isFinal: !hasMore, nextPart: nextPartVal, bringIdx: bringIdx });
            if (!hasMore) break;
        }
        return steps;
    }

    resize() {
        const rect = this.container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        const targetHeight = rect.width * (this.logicalHeight / this.logicalWidth);
        this.canvas.width = rect.width * dpr;
        this.canvas.height = targetHeight * dpr;
        this.canvas.style.width = `${rect.width}px`;
        this.canvas.style.height = `${targetHeight}px`;
        this.ctx.scale(dpr * (rect.width / this.logicalWidth), dpr * (rect.width / this.logicalWidth));
        this.draw();
        if (!this.inputEl.classList.contains('hidden')) this.positionInput();
    }

    handleAction() {
        if (this.state.waitingForContinue) {
            this.state.waitingForContinue = false;
            this.actionBtn.classList.add('hidden');
            this.numpad.classList.remove('hidden');
            const lastRestoStep = this.steps[this.state.stepIndex];
            this.state.stepIndex++; 
            const currentRow = lastRestoStep.row; 
            const nextNumStr = String(lastRestoStep.nextPart);
            this.state.highlightInfo = { start: 0, length: nextNumStr.length, isPartial: true, row: currentRow + 1 };
            this.updateUI();
            this.showInputForCurrentStep();
        }
    }

    inputDigit(digit) {
        if (this.inputEl.classList.contains('hidden')) return;
        const currentStep = this.steps[this.state.stepIndex];
        const maxLen = String(currentStep.correct).length;
        if (this.state.inputValue.length < maxLen) {
            this.state.inputValue += String(digit); 
            this.inputEl.value = this.state.inputValue;
        }
    }

    deleteDigit() { this.state.inputValue = this.state.inputValue.slice(0, -1); this.inputEl.value = this.state.inputValue; }

    submitInput() {
        if (this.inputEl.classList.contains('hidden') || this.state.inputValue === '') return;
        const val = parseInt(this.state.inputValue, 10);
        const currentStep = this.steps[this.state.stepIndex];
        if (val === currentStep.correct) {
            this.inputEl.classList.remove('bg-red-100', 'border-red-500');
            this.handleCorrectAnswer(val, currentStep);
        } else {
            this.inputEl.classList.add('bg-red-100', 'border-red-500');
            this.showMessage("ü§î Ups, intenta de nuevo. ¬°Usa la Ayuda üÜò si la necesitas!", true);
            setTimeout(() => { this.state.inputValue = ''; this.inputEl.value = ''; }, 800);
        }
    }

    handleCorrectAnswer(val, step) {
        if (step.type === 'COC') this.state.history.quotient.push(val);
        if (step.type === 'PROD') this.state.history.products.push({val, row: step.row});
        if (step.type === 'RESTO') this.state.history.residues.push({val, row: step.row});
        this.state.inputValue = '';
        this.inputEl.classList.add('hidden');
        this.inputEl.value = '';
        if (step.isFinal) {
            this.state.isFinished = true; // Marcar como terminado para dibujar resumen
            this.numpad.classList.add('hidden');
            this.draw(); // Redibujar para mostrar el sello final
            app.problemSolved(); 
            return;
        }
        if (step.type === 'RESTO' && step.nextPart !== null) {
            this.state.waitingForContinue = true;
            this.numpad.classList.add('hidden');
            this.actionBtn.classList.remove('hidden');
            this.state.history.partials.push({ val: step.nextPart, row: step.row + 1 });
            const digitBroughtDown = String(step.nextPart).slice(-1);
            this.showMessage(`¬°Bien! Baja el <strong>${digitBroughtDown}</strong>. Tienes <strong>${step.nextPart}</strong>.`);
            this.draw(); 
        } else {
            this.state.stepIndex++;
            this.updateUI();
            this.showInputForCurrentStep();
        }
    }

    updateUI() {
        const step = this.steps[this.state.stepIndex];
        this.showMessage(step.msg);
        this.draw();
    }

    showMessage(html, isError = false) {
        this.msgBox.innerHTML = html;
        const container = document.getElementById('messageBox');
        // Inherits basic style from app setup
    }

    showInputForCurrentStep() { this.positionInput(); this.inputEl.classList.remove('hidden'); this.inputEl.focus(); }
    getAlignedX(row, numberLength) { const { startX, spacing } = this.config; const colIndex = this.alignmentMap[row]; const rightmostX = startX + (colIndex * spacing); const leftmostX = rightmostX - ((numberLength - 1) * spacing); return (leftmostX + rightmostX) / 2; }
    drawAlignedNumber(str, row, y, color) { const { startX, spacing } = this.config; const colIndex = this.alignmentMap[row]; const rightmostX = startX + (colIndex * spacing); this.ctx.fillStyle = color; for (let i = 0; i < str.length; i++) { const char = str[str.length - 1 - i]; const x = rightmostX - (i * spacing); this.ctx.fillText(char, x, y); } return { left: rightmostX - (str.length-1)*spacing, right: rightmostX }; }

    positionInput() {
        const step = this.steps[this.state.stepIndex];
        let lx, ly;
        const { startX, startY, spacing, lineH } = this.config;
        if (step.type === 'COC') {
            const idx = this.state.history.quotient.length;
            const divLen = String(this.DIVIDEND).length;
            const separatorX = startX + (divLen * spacing) + 20;
            lx = separatorX + (spacing * 0.8 * idx) + 40; 
            ly = startY + 50; 
        } else {
            const row = step.row;
            const yBase = startY + lineH + (row * lineH * 2.5);
            lx = this.getAlignedX(row, String(step.correct).length);
            ly = (step.type === 'PROD') ? yBase : yBase + lineH;
        }
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = rect.width / this.logicalWidth;
        const scaleY = rect.height / this.logicalHeight;
        this.inputEl.style.left = `${lx * scaleX}px`;
        this.inputEl.style.top = `${ly * scaleY}px`;
    }

    draw() {
        const ctx = this.ctx;
        const { startX, startY, spacing, lineH, colors, fontMain } = this.config;
        ctx.clearRect(0, 0, this.logicalWidth, this.logicalHeight);
        ctx.strokeStyle = colors.pencil;
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        const divStr = String(this.DIVIDEND);
        const divLen = divStr.length;
        const separatorX = startX + (divLen * spacing) + 20;
        
        ctx.beginPath(); ctx.moveTo(separatorX, startY - 40); ctx.lineTo(separatorX, startY + (this.state.history.products.length * lineH * 2.5) + 150); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(separatorX, startY + 10); ctx.lineTo(separatorX + (String(this.DIVISOR).length * spacing) + 40, startY + 10); ctx.stroke();

        ctx.font = fontMain;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = colors.accent;
        ctx.fillText(this.DIVISOR, separatorX + spacing, startY - 20);

        for(let i=0; i<divLen; i++) {
            const x = startX + (i * spacing);
            const y = startY - 20;
            if (this.state.highlightInfo && !this.state.highlightInfo.isPartial && !this.state.waitingForContinue && !this.state.isFinished) {
                if (i >= this.state.highlightInfo.start && i < (this.state.highlightInfo.start + this.state.highlightInfo.length)) {
                     ctx.fillStyle = colors.highlight;
                     ctx.fillRect(x - spacing/2, y - 30, spacing, 60);
                }
            }
            ctx.fillStyle = colors.text;
            ctx.fillText(divStr[i], x, y);
        }

        this.state.history.quotient.forEach((digit, idx) => {
            ctx.fillStyle = colors.success;
            ctx.fillText(digit, separatorX + (spacing * 0.8 * idx) + 40, startY + 50);
        });

        this.state.history.products.forEach((p, i) => {
            const yBase = startY + lineH + (i * lineH * 2.5);
            const pStr = String(p.val);
            const bounds = this.drawAlignedNumber(pStr, i, yBase, colors.pencil);
            ctx.beginPath(); ctx.moveTo(bounds.left - 10, yBase + 25); ctx.lineTo(bounds.right + 10, yBase + 25); ctx.stroke();
            ctx.font = "20px Fredoka"; ctx.fillText("-", bounds.left - 20, yBase); ctx.font = fontMain;
            if (this.state.history.residues[i]) {
                const r = this.state.history.residues[i];
                this.drawAlignedNumber(String(r.val), i, yBase + lineH, colors.success);
            }
        });

        this.state.history.partials.forEach((partial, idx) => {
            const yBase = startY + lineH + (idx * lineH * 2.5) + lineH; 
            const pStr = String(partial.val);
            if (this.state.highlightInfo && this.state.highlightInfo.isPartial && this.state.highlightInfo.row === idx + 1 && !this.state.waitingForContinue && !this.state.isFinished) {
                const colIdx = this.alignmentMap[idx + 1];
                const rX = startX + (colIdx * spacing);
                const lX = rX - (pStr.length-1)*spacing;
                const w = (pStr.length * spacing);
                ctx.fillStyle = colors.highlight;
                ctx.fillRect(lX - spacing/2, yBase - 30, w, 60);
            }
            this.drawAlignedNumber(pStr, idx + 1, yBase, colors.success);
        });

        if (this.state.waitingForContinue) {
            const lastResidueIdx = this.state.history.residues.length - 1;
            const bringIdx = this.steps[this.state.stepIndex].bringIdx;
            const xFrom = startX + (bringIdx * spacing);
            const yFrom = startY + 15;
            const yBase = startY + lineH + (lastResidueIdx * lineH * 2.5) + lineH;
            const nextColIdx = this.alignmentMap[lastResidueIdx + 1];
            const xTo = startX + (nextColIdx * spacing);
            this.drawArrow(ctx, xFrom, yFrom, xTo, yBase - 20);
        }
        
        // --- DIBUJO DEL RESUMEN FINAL ---
        if (this.state.isFinished) {
            // Coordenadas para el sello a la derecha de la operaci√≥n
            const divLen = String(this.DIVIDEND).length;
            const finalX = separatorX + 250; 
            const finalY = startY + 150;
            
            // Sello de fondo
            ctx.save();
            ctx.translate(finalX, finalY);
            ctx.rotate(-0.1); // Leve inclinaci√≥n para efecto sello
            
            // Borde estilo sello
            ctx.strokeStyle = colors.accent;
            ctx.lineWidth = 4;
            ctx.fillStyle = '#fffbe6'; // Papel
            ctx.beginPath();
            ctx.roundRect(-120, -80, 240, 160, 20);
            ctx.fill();
            ctx.stroke();
            
            // Texto
            ctx.textAlign = 'center';
            ctx.font = 'bold 28px "Fredoka"';
            ctx.fillStyle = colors.text;
            
            // T√≠tulo
            ctx.fillText("¬°COMPLETADO!", 0, -40);
            
            // Datos
            ctx.font = '24px "Fredoka"';
            ctx.fillStyle = '#4b5563';
            
            // Cociente
            const quotient = this.state.history.quotient.join('');
            ctx.fillText(`Cociente = ${quotient}`, 0, 10);
            
            // Residuo
            const residuo = this.state.history.residues[this.state.history.residues.length - 1].val;
            ctx.fillText(`Residuo = ${residuo}`, 0, 50);
            
            ctx.restore();
        }
    }

    drawArrow(ctx, x1, y1, x2, y2) {
        ctx.strokeStyle = this.config.colors.accent; ctx.lineWidth = 3; ctx.setLineDash([8, 6]);
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.bezierCurveTo(x1, y1 + 50, x2, y2 - 50, x2, y2); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle = this.config.colors.accent; ctx.beginPath(); ctx.moveTo(x2, y2 + 10); ctx.lineTo(x2 - 8, y2 - 8); ctx.lineTo(x2 + 8, y2 - 8); ctx.fill();
    }
}

window.game = new DivisionEngine();
</script>
</body>
</html>
